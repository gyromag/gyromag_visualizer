<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js sample code</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
        <script src="https://cdn.babylonjs.com/recast.js"></script>
        <script src="https://cdn.babylonjs.com/ammo.js"></script>
        <script src="https://cdn.babylonjs.com/havok/HavokPhysics_umd.js"></script>
        <script src="https://cdn.babylonjs.com/cannon.js"></script>
        <script src="https://cdn.babylonjs.com/Oimo.js"></script>
        <script src="https://cdn.babylonjs.com/earcut.min.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/addons/babylonjs.addons.min.js"></script>
        <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html,
            body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }

            #canvasZone {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="canvasZone"><canvas id="renderCanvas"></canvas></div>
        <script>
                    var canvas = document.getElementById("renderCanvas");

                    var startRenderLoop = function (engine, canvas) {
                        engine.runRenderLoop(function () {
                            if (sceneToRender && sceneToRender.activeCamera) {
                                sceneToRender.render();
                            }
                        });
                    }

                    var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function() { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false}); };
        var createScene = function() {
    var scene = new BABYLON.Scene(engine);

    var camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI / 2, Math.PI / 2, 12, BABYLON.Vector3.Zero(), scene);
    //var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 5, -10), scene);

var light = new BABYLON.HemisphericLight("hemiLight", new BABYLON.Vector3(0, 1, 0), scene);
//    new BABYLON.AxesViewer(scene, 1  );

var B1=0;

//var arrow = new BABYLON.TransformNode("arrow", scene);
//var cylinder = BABYLON.MeshBuilder.CreateCylinder("cylinder", {height: 2, diameter: 0.05}, scene);
//var cylinder2 = BABYLON.MeshBuilder.CreateCylinder("cylinder", {height: 0.1, diameter: 0.1,diameterTop: 0}, scene);
//cylinder.position.y = 1;
//cylinder.parent=arrow;
//cylinder2.position.y = 2;
//cylinder2.parent=arrow;

var atom = BABYLON.MeshBuilder.CreateSphere("Atom", {diameter: 0.3}, scene);

const ArrowCurve = (ep) => {
        const path = [];
        const len = ep.length();        
        const head=ep.scale((len-0.1)/len);
        path.push(new BABYLON.Vector3(0, 0, 0 ))
        path.push(head),
        path.push(head),
        path.push(head),
        path.push(head),         
        path.push(ep)
        return path;
    };





const radiusChange = (index, distance) => {
    var radius;
    if (index<3)  
    { 
      radius = 0.03;
    }  else  if (index<5) {
      radius = 0.07;
    } else {
        radius = 0;
    }
    return radius;
};

ve=new BABYLON.Vector3(1., 1.1, 0);

let tube = BABYLON.MeshBuilder.CreateTube("tube", {path: ArrowCurve(ve), radiusFunction: radiusChange, sideOrientation: BABYLON.Mesh.DOUBLESIDE, updatable: true}, scene);

var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size:1000.0}, scene);

var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);

skyboxMaterial.backFaceCulling = false;
skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0); skybox.material = skyboxMaterial;


    // This targets the camera to scene origin
    camera.setTarget(BABYLON.Vector3.Zero());


    // This attaches the camera to the canvas
    camera.attachControl(canvas, true);

    camera.lowerRadiusLimit = 5;// (debugNode as BABYLON.ArcRotateCamera)
    camera.upperRadiusLimit = 100;// (debugNode as BABYLON.ArcRotateCamera)
    camera.panningSensibility = 2;// (debugNode as BABYLON.ArcRotateCamera)
    camera.speed = 1;// (debugNode as BABYLON.ArcRotateCamera)
    camera.inertia = 0.3;// (debugNode as BABYLON.ArcRotateCamera)
    camera.angularSensibilityX = 100;// (debugNode as BABYLON.ArcRotateCamera)
    camera.angularSensibilityY = 100;// (debugNode as BABYLON.ArcRotateCamera)

let speed = 0;

 // GUI
    var gui  = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
    

        const grid = new BABYLON.GUI.Grid();
        grid.addColumnDefinition(50, true);  // Column 1: fixed width
        grid.addColumnDefinition(50, true);        // Column 2: relative width
        grid.addColumnDefinition(1);  // Column 3: fixed width
        grid.addColumnDefinition(100 , true); 
        grid.addRowDefinition(25, true);
        grid.addRowDefinition(25, true);
        grid.addRowDefinition(25, true);
        
        gui.addControl(grid);
grid.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
        grid.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
        grid.width = "80%";
        grid.height = "150px";

        const grid2 = new BABYLON.GUI.Grid();
        grid2.addColumnDefinition(50, true);  // Column 1: fixed width
        grid2.addColumnDefinition(50, true);        // Column 2: relative width
        grid2.addRowDefinition(25, true);
        grid2.addRowDefinition(25, true);
        //gui.addControl(grid2);
        grid.addControl(grid2, 2, 2);

            // Checkbox
            const checkbox1 = new BABYLON.GUI.Checkbox();
            checkbox1.width = "20px";
            checkbox1.height = "20px";
            checkbox1.color = "white";
            checkbox1.isChecked = false;
            grid2.addControl(checkbox1, 0, 0);

            const checkbox2 = new BABYLON.GUI.Checkbox();
            checkbox2.width = "20px";
            checkbox2.height = "20px";
            checkbox2.color = "white";
            checkbox2.isChecked = false;
            checkbox2.onIsCheckedChangedObservable.add(function(value) {
                if (sliderB1 && value) {
                    slider.color = "green";                    
                }
                if (sliderB1 && !value) {
                    slider.color = "gray";                    
                }
                
            });
            
            grid.addControl(checkbox2, 1, 0);

            
            const labelB0 = new BABYLON.GUI.TextBlock();
            labelB0.text = `B0`;
            labelB0.color = "white";
            labelB0.fontSize = 18;
            labelB0.height = "30px";
            labelB0.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            grid.addControl(labelB0, 0, 1);

            const valueB0 = new BABYLON.GUI.TextBlock();
            valueB0.text = `0`;
            valueB0.color = "white";
            valueB0.fontSize = 18;
            valueB0.height = "30px";
            valueB0.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            grid.addControl(valueB0, 0, 3);

            const labelB1 = new BABYLON.GUI.TextBlock();
            labelB1.text = `B1`;
            labelB1.color = "white";
            labelB1.fontSize = 18;
            labelB1.height = "30px";
            labelB1.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            grid.addControl(labelB1, 1, 1);

            const valueB1 = new BABYLON.GUI.TextBlock();
            valueB1.text = `0`;
            valueB1.color = "white";
            valueB1.fontSize = 18;
            valueB1.height = "30px";
            valueB1.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            grid.addControl(valueB1, 1, 3);
            
            
            // Slider for B1
            const sliderB1 = new BABYLON.GUI.Slider();
            sliderB1.minimum = -100;
            sliderB1.maximum = 100;
            sliderB1.value = 0;
            sliderB1.height = "20px";
            sliderB1.width = "100%";
            sliderB1.color = "green";
            sliderB1.background = "gray";
            sliderB1.onValueChangedObservable.add(function(value) {
               B1 = Math.round(value, 2);
               valueB1.text = "f = " + B1;
               speed=B1*0.01;               
             });
            grid.addControl(sliderB1, 1, 2);

            // Slider for B0
            const sliderB0 = new BABYLON.GUI.Slider();
            sliderB0.minimum = -100;
            sliderB0.maximum = 100;
            sliderB0.value = 0;
            sliderB0.height = "20px";
            sliderB0.width = "100%";
            sliderB0.color = "green";
            sliderB0.background = "gray";
            sliderB0.onValueChangedObservable.add(function(value) {
                B0 = Math.round(value, 2);
                valueB0.text = "B0 = " + B0;
                // You can add any logic for B0 here
            });
            grid.addControl(sliderB0, 0, 2);
        


/*

    var panel = new BABYLON.GUI.StackPanel();

    panel.hight = "220px";
    panel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
    panel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    advancedTexture.addControl(panel);


var slider = new BABYLON.GUI.Slider();
    slider.minimum = 0;
    slider.maximum = 2 * Math.PI;
    slider.value = 0;
    slider.height = "20px";
    slider.width = "400px";
    slider.onValueChangedObservable.add(function(value) {
        header.text = "Y-rotation: " + (BABYLON.Tools.ToDegrees(value) | 0) + " deg";        
        speed=value/100.;
    });
    panel.addControl(slider); 

    var header = new BABYLON.GUI.TextBlock();
    header.text = "Y-rotation: 0 deg";
    header.height = "30px";
    header.color = "white";
    panel.addControl(header); 

    var slider = new BABYLON.GUI.Slider();
    slider.minimum = 0;
    slider.maximum = 2 * Math.PI;
    slider.value = 0;
    slider.height = "20px";
    slider.width = "400px";
    slider.onValueChangedObservable.add(function(value) {
        header.text = "Y-rotation: " + (BABYLON.Tools.ToDegrees(value) | 0) + " deg";        
        speed=value/100.;
    });
    panel.addControl(slider); 

var checkbox = new BABYLON.GUI.Checkbox();
    checkbox.width = "20px";
    checkbox.height = "20px";
    checkbox.isChecked = true;
    checkbox.color = "green";
    checkbox.onIsCheckedChangedObservable.add(function(value) {
        if (skull) {
            skull.useVertexColors = value;
        }
    });
    panel.addControl(checkbox);   

    var header2 = new BABYLON.GUI.TextBlock();
    header2.text = "use vertex colors";
    header2.width = "180px";
    header2.marginLeft = "5px";
    header2.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
    header2.color = "white";
    panel.addControl(header2);     
    
    var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", length);
    
    button1.verticalAlignment = 1;// (debugNode as BABYLON.Unknown)
    button1.width = "550px";
    button1.height = "50px";
    button1.color = "white";
    button1.cornerRadius = 0    ;
    button1.background = "green";
    button1.onPointerUpObservable.add(function() {
        alert("you did it!");
    });
    panel.addControl(button1); 
*/

 let angle = 0;
    scene.registerBeforeRender(function(){
        // arrow.rotation.z = angle;       
        bf = new BABYLON.Vector3(0,speed,0);
        dv = ve.cross(bf);
        ve.addInPlace(dv);        
        tube = BABYLON.MeshBuilder.CreateTube("tube", {path: ArrowCurve(ve),  radiusFunction: radiusChange, sideOrientation: BABYLON.Mesh.DOUBLESIDE,instance: tube, updatable:true} ); 
    })

// Finally create the motion blur effect :)
    //var mb = new BABYLON.MotionBlurPostProcess('mb', scene, 1, camera);


    return scene;
};

                window.initFunction = async function() {
                    
                    
                    
                    var asyncEngineCreation = async function() {
                        try {
                        return createDefaultEngine();
                        } catch(e) {
                        console.log("the available createEngine function failed. Creating the default engine instead");
                        return createDefaultEngine();
                        }
                    }

                    window.engine = await asyncEngineCreation();
                    
                    const engineOptions = window.engine.getCreationOptions?.();
                    if (!engineOptions || engineOptions.audioEngine !== false) {
                        
                    }
        if (!engine) throw 'engine should not be null.';
        startRenderLoop(engine, canvas);
        window.scene = createScene();};
        initFunction().then(() => {sceneToRender = scene
                    });

                    // Resize
                    window.addEventListener("resize", function () {
                        engine.resize();
                    });
        </script>
    </body>
</html>
